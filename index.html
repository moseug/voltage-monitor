<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–õ–ê–í–ê –ø–æ–¥ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header { text-align: center; color: #111; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; font-weight: 300; margin-bottom: 10px; }
        .header p { font-size: 1.1em; color: #555; }

        .last-update { text-align: center; color: #444; margin-bottom: 20px; font-size: 0.9em; }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }

        .card-title { font-size: 0.9em; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        .voltage-value { font-size: 3em; font-weight: 700; margin-bottom: 10px; }
        .voltage-value.phase-a { color: #795548; }
        .voltage-value.phase-b { color: #111111; }
        .voltage-value.phase-c { color: #888888; }
        .voltage-unit { font-size: 0.4em; color: #999; margin-left: 5px; }

        .status {
            display: inline-block; padding: 5px 15px;
            border-radius: 20px; font-size: 0.85em; font-weight: 600;
        }
        .status.normal  { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.danger  { background: #f8d7da; color: #721c24; }

        .chart-container {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px;
        }

        .chart-controls { display: flex; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }

        .period-btn {
            padding: 8px 20px; border: 2px solid #111; background: white;
            color: #111; border-radius: 8px; cursor: pointer;
            font-weight: 600; transition: all 0.3s ease;
        }
        .period-btn:hover, .period-btn.active { background: #111; color: white; }

        .custom-period {
            display: none; align-items: center; gap: 10px;
            flex-wrap: wrap; margin-bottom: 15px;
        }
        .custom-period label { color: #111; font-weight: 600; }
        .custom-period input[type="date"] {
            padding: 6px 10px; border: 2px solid #ccc;
            border-radius: 8px; font-size: 0.95em;
        }

        .export-btn {
            padding: 10px 25px; background: #28a745; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 1em; transition: all 0.3s ease;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .export-btn:hover { background: #218838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40,167,69,0.3); }

        .info-section { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .info-title { font-size: 1.5em; font-weight: 600; color: #333; margin-bottom: 20px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }

        .info-item { padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #795548; }
        .info-item h4 { color: #795548; margin-bottom: 10px; }
        .info-item p { color: #666; line-height: 1.6; }

        .compliance { margin-top: 20px; padding: 20px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #17a2b8; }
        .compliance h4 { color: #17a2b8; margin-bottom: 15px; }

        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .voltage-value { font-size: 2.5em; }
            .chart-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <h1>‚ö° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ—Å–µ—Ç–∏</h1>
        <p>–¢—Ä–µ—Ö—Ñ–∞–∑–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ ¬∑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç</p>
    </div>

    <div class="last-update" id="last-update">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div id="error-container"></div>

    <div class="cards">
        <div class="card">
            <div class="card-title">–§–∞–∑–∞ A</div>
            <div class="voltage-value phase-a" id="phase-a">‚Äî<span class="voltage-unit">–í</span></div>
            <span class="status" id="status-a">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="card">
            <div class="card-title">–§–∞–∑–∞ B</div>
            <div class="voltage-value phase-b" id="phase-b">‚Äî<span class="voltage-unit">–í</span></div>
            <span class="status" id="status-b">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="card">
            <div class="card-title">–§–∞–∑–∞ C</div>
            <div class="voltage-value phase-c" id="phase-c">‚Äî<span class="voltage-unit">–í</span></div>
            <span class="status" id="status-c">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-controls">
            <button class="period-btn active" onclick="changePeriod('today', this)">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="period-btn" onclick="changePeriod('yesterday', this)">–í—á–µ—Ä–∞</button>
            <button class="period-btn" onclick="changePeriod('week', this)">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
            <button class="period-btn" onclick="changePeriod('month', this)">–ó–∞ –º–µ—Å—è—Ü</button>
            <button class="period-btn" onclick="changePeriod('custom', this)">–ó–∞ –ø–µ—Ä–∏–æ–¥</button>
        </div>

        <div class="custom-period" id="custom-period">
            <label>–°:</label>
            <input type="date" id="date-from">
            <label>–ü–æ:</label>
            <input type="date" id="date-to">
            <button class="period-btn active" onclick="applyCustomPeriod()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        <canvas id="voltageChart"></canvas>

        <div style="text-align: center; margin-top: 20px;">
            <button class="export-btn" onclick="exportToExcel()">üìä –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</button>
        </div>
    </div>

    <div class="info-section">
        <h3 class="info-title">üìã –ù–æ—Ä–º—ã —ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è –≤ –†–æ—Å—Å–∏–∏</h3>
        <div class="info-grid">
            <div class="info-item">
                <h4>–ù–æ–º–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ</h4>
                <p><strong>220 –í (230 –í –ø–æ –ì–û–°–¢ 29322-2014)</strong><br>
                –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –æ–¥–Ω–æ—Ñ–∞–∑–Ω–æ–π —Å–µ—Ç–∏ –≤ –†–æ—Å—Å–∏–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 220 –í, –æ–¥–Ω–∞–∫–æ —Å–æ–≥–ª–∞—Å–Ω–æ –ì–û–°–¢ 29322-2014 –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ 230 –í –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏.</p>
            </div>
            <div class="info-item">
                <h4>–î–æ–ø—É—Å—Ç–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</h4>
                <p><strong>¬±10% (207‚Äì253 –í)</strong><br>
                –°–æ–≥–ª–∞—Å–Ω–æ –ì–û–°–¢ 29322-2014, –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç ¬±10% –æ—Ç –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è 230 –í, —Ç–æ –µ—Å—Ç—å –æ—Ç 207 –¥–æ 253 –í.</p>
            </div>
            <div class="info-item">
                <h4>–ü—Ä–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</h4>
                <p><strong>¬±15% (195.5‚Äì264.5 –í)</strong><br>
                –ü—Ä–µ–¥–µ–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç ¬±15% –æ—Ç –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –í—ã—Ö–æ–¥ –∑–∞ —ç—Ç–∏ –ø—Ä–µ–¥–µ–ª—ã —è–≤–ª—è–µ—Ç—Å—è –≥—Ä—É–±—ã–º –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –∫–∞—á–µ—Å—Ç–≤–∞ —ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è.</p>
            </div>
            <div class="info-item">
                <h4>–î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è</h4>
                <p><strong>–î–æ 72 —á–∞—Å–æ–≤ –≤ –≥–æ–¥</strong><br>
                –°–æ–≥–ª–∞—Å–Ω–æ –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –†–§ ‚Ññ354, —Å—É–º–º–∞—Ä–Ω–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ —ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 72 —á–∞—Å–∞ –≤ –≥–æ–¥ (–¥–ª—è –Ω–∞—Å–µ–ª–µ–Ω–∏—è).</p>
            </div>
            <div class="info-item">
                <h4>–ß–∞—Å—Ç–æ—Ç–∞ —Å–µ—Ç–∏</h4>
                <p><strong>50 –ì—Ü ¬±0.2 –ì—Ü</strong><br>
                –ù–æ–º–∏–Ω–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π —Å–µ—Ç–∏ –≤ –†–æ—Å—Å–∏–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 50 –ì—Ü —Å –¥–æ–ø—É—Å—Ç–∏–º—ã–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ–º ¬±0.2 –ì—Ü –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç—ã.</p>
            </div>
            <div class="info-item">
                <h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏</h4>
                <p><strong>I, II, III –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</strong><br>
                I –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî –ø–µ—Ä–µ—Ä—ã–≤ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (—Å–µ–∫). II –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî –¥–æ 2 —á–∞—Å–æ–≤. III –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî –¥–æ 24 —á–∞—Å–æ–≤.</p>
            </div>
        </div>
        <div class="compliance">
            <h4>üîç –û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–æ—Ä–º–∞–º</h4>
            <div id="compliance-info"><p>–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è...</p></div>
        </div>
    </div>

</div>

<script>
    let voltageHistory = [];
    let currentPeriodKey = 'today';
    let chart = null;

    function initChart() {
        const ctx = document.getElementById('voltageChart').getContext('2d');

        // –ü–ª–∞–≥–∏–Ω –¥–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö –∑–æ–Ω —Ñ–æ–Ω–∞
        const bgZones = {
            id: 'bgZones',
            beforeDraw(chart) {
                const { ctx, chartArea: { left, right, top, bottom }, scales: { y } } = chart;
                if (!y) return;

                const y198 = y.getPixelForValue(198);
                const y242 = y.getPixelForValue(242);
                const yTop = y.getPixelForValue(y.max);
                const yBot = y.getPixelForValue(y.min);

                ctx.save();
                // –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞ –≤–µ—Ä—Ö (–≤—ã—à–µ 242)
                ctx.fillStyle = 'rgba(255, 100, 100, 0.08)';
                ctx.fillRect(left, yTop, right - left, y242 - yTop);
                // –ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞ (198‚Äì242)
                ctx.fillStyle = 'rgba(100, 200, 100, 0.08)';
                ctx.fillRect(left, y242, right - left, y198 - y242);
                // –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞ –Ω–∏–∑ (–Ω–∏–∂–µ 198)
                ctx.fillStyle = 'rgba(255, 100, 100, 0.08)';
                ctx.fillRect(left, y198, right - left, yBot - y198);
                ctx.restore();
            }
        };

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: '–§–∞–∑–∞ A', data: [],
                        borderColor: '#795548', backgroundColor: 'transparent',
                        tension: 0.4, borderWidth: 2, pointRadius: 0
                    },
                    {
                        label: '–§–∞–∑–∞ B', data: [],
                        borderColor: '#111111', backgroundColor: 'transparent',
                        tension: 0.4, borderWidth: 2, pointRadius: 0
                    },
                    {
                        label: '–§–∞–∑–∞ C', data: [],
                        borderColor: '#888888', backgroundColor: 'transparent',
                        tension: 0.4, borderWidth: 2, pointRadius: 0
                    }
                ]
            },
            plugins: [bgZones],
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.5,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        min: 170, max: 270,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { callback: v => v + ' –í' }
                    },
                    x: {
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
    }

    async function loadData() {
        try {
            const latestRes = await fetch('data/latest.json');
            if (!latestRes.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å latest.json');
            const latest = await latestRes.json();

            updateDisplay(latest);
            updateCompliance(latest);
            document.getElementById('last-update').textContent =
                '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ' + new Date(latest.timestamp).toLocaleString('ru-RU');

            const histRes = await fetch('data/voltage-history.json');
            if (!histRes.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å voltage-history.json');
            voltageHistory = await histRes.json();

            updateChart();
            clearError();
        } catch (e) {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
        }
    }

    function updateDisplay(v) {
        document.getElementById('phase-a').innerHTML = v.phaseA.toFixed(1) + '<span class="voltage-unit">–í</span>';
        document.getElementById('phase-b').innerHTML = v.phaseB.toFixed(1) + '<span class="voltage-unit">–í</span>';
        document.getElementById('phase-c').innerHTML = v.phaseC.toFixed(1) + '<span class="voltage-unit">–í</span>';
        updateStatus('status-a', v.phaseA);
        updateStatus('status-b', v.phaseB);
        updateStatus('status-c', v.phaseC);
    }

    function updateStatus(id, val) {
        const el = document.getElementById(id);
        el.className = 'status';
        if (val >= 207 && val <= 253)         { el.classList.add('normal');  el.textContent = '–ù–æ—Ä–º–∞'; }
        else if (val >= 195.5 && val <= 264.5) { el.classList.add('warning'); el.textContent = '–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ'; }
        else                                   { el.classList.add('danger');  el.textContent = '–û–ø–∞—Å–Ω–æ!'; }
    }

    const DAY_NAMES = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

    function updateChart() {
        let range, buildLabels;

        if (currentPeriodKey === 'today' || currentPeriodKey === 'yesterday') {
            // –°—É—Ç–∫–∏: –±–∞–∫–µ—Ç—ã –ø–æ —á–∞—Å–∞–º 1..24, –¥–∞–Ω–Ω—ã–µ —É—Å—Ä–µ–¥–Ω—è–µ–º –ø–æ —á–∞—Å—É
            let dayStart;
            if (currentPeriodKey === 'today') {
                dayStart = new Date(); dayStart.setHours(0,0,0,0);
            } else {
                dayStart = new Date(); dayStart.setDate(dayStart.getDate()-1); dayStart.setHours(0,0,0,0);
            }

            // –°–æ–∑–¥–∞—ë–º 24 –±–∞–∫–µ—Ç–∞ (—á–∞—Å—ã 0‚Äì23, –ø–æ–¥–ø–∏—Å—å 1‚Äì24)
            const buckets = Array.from({length: 24}, () => ({ a:[], b:[], c:[] }));
            voltageHistory.forEach(r => {
                const t = new Date(r.timestamp);
                const h = t.getHours();
                const dayOfRecord = new Date(t); dayOfRecord.setHours(0,0,0,0);
                if (dayOfRecord.getTime() === dayStart.getTime()) {
                    buckets[h].a.push(r.phaseA);
                    buckets[h].b.push(r.phaseB);
                    buckets[h].c.push(r.phaseC);
                }
            });

            const labels = [], dA = [], dB = [], dC = [];
            buckets.forEach((b, i) => {
                labels.push(String(i + 1));
                dA.push(b.a.length ? avg(b.a) : null);
                dB.push(b.b.length ? avg(b.b) : null);
                dC.push(b.c.length ? avg(b.c) : null);
            });
            setChartData(labels, dA, dB, dC);
            return;
        }

        if (currentPeriodKey === 'week') {
            // 7 –¥–Ω–µ–π: –±–∞–∫–µ—Ç—ã –ø–æ –¥–Ω—è–º, –ø–æ–¥–ø–∏—Å—å –ü–Ω/–í—Ç/...
            const today = new Date(); today.setHours(0,0,0,0);
            const buckets = Array.from({length: 7}, (_, i) => {
                const d = new Date(today); d.setDate(d.getDate() - (6 - i));
                return { date: d, a:[], b:[], c:[] };
            });
            voltageHistory.forEach(r => {
                const t = new Date(r.timestamp);
                const dayKey = new Date(t); dayKey.setHours(0,0,0,0);
                const bk = buckets.find(b => b.date.getTime() === dayKey.getTime());
                if (bk) { bk.a.push(r.phaseA); bk.b.push(r.phaseB); bk.c.push(r.phaseC); }
            });
            const labels = buckets.map(b => DAY_NAMES[b.date.getDay()]);
            const dA = buckets.map(b => b.a.length ? avg(b.a) : null);
            const dB = buckets.map(b => b.b.length ? avg(b.b) : null);
            const dC = buckets.map(b => b.c.length ? avg(b.c) : null);
            setChartData(labels, dA, dB, dC);
            return;
        }

        if (currentPeriodKey === 'month') {
            // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –æ—Ç 1-–≥–æ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∏—Å–ª–∞
            const now = new Date();
            const year = now.getFullYear(), month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const buckets = Array.from({length: daysInMonth}, (_, i) => {
                const d = new Date(year, month, i + 1);
                return { date: d, a:[], b:[], c:[] };
            });
            voltageHistory.forEach(r => {
                const t = new Date(r.timestamp);
                if (t.getFullYear() === year && t.getMonth() === month) {
                    const idx = t.getDate() - 1;
                    buckets[idx].a.push(r.phaseA);
                    buckets[idx].b.push(r.phaseB);
                    buckets[idx].c.push(r.phaseC);
                }
            });
            const labels = buckets.map(b => String(b.date.getDate()));
            const dA = buckets.map(b => b.a.length ? avg(b.a) : null);
            const dB = buckets.map(b => b.b.length ? avg(b.b) : null);
            const dC = buckets.map(b => b.c.length ? avg(b.c) : null);
            setChartData(labels, dA, dB, dC);
            return;
        }

        if (currentPeriodKey === 'custom') {
            const fromVal = document.getElementById('date-from').value;
            const toVal   = document.getElementById('date-to').value;
            if (!fromVal || !toVal) return;
            const from = new Date(fromVal);
            const to   = new Date(toVal); to.setHours(23,59,59,999);
            const days = Math.round((to - from) / 86400000) + 1;

            if (days <= 1) {
                // –û–¥–∏–Ω –¥–µ–Ω—å ‚Äî 24 —á–∞—Å–∞
                const buckets = Array.from({length: 24}, () => ({ a:[], b:[], c:[] }));
                voltageHistory.forEach(r => {
                    const t = new Date(r.timestamp);
                    if (t >= from && t <= to) buckets[t.getHours()].a.push(r.phaseA) || buckets[t.getHours()].b.push(r.phaseB) || buckets[t.getHours()].c.push(r.phaseC);
                });
                // —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è custom 1 –¥–µ–Ω—å
                const labels = [], dA = [], dB = [], dC = [];
                voltageHistory.forEach(r => {
                    const t = new Date(r.timestamp);
                    if (t >= from && t <= to) {
                        labels.push(t.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}));
                        dA.push(r.phaseA); dB.push(r.phaseB); dC.push(r.phaseC);
                    }
                });
                setChartData(labels, dA, dB, dC);
            } else {
                // –ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π ‚Äî –ø–æ –¥–∞—Ç–∞–º
                const buckets = [];
                for (let i = 0; i < days; i++) {
                    const d = new Date(from); d.setDate(d.getDate() + i);
                    buckets.push({ date: d, a:[], b:[], c:[] });
                }
                voltageHistory.forEach(r => {
                    const t = new Date(r.timestamp);
                    if (t >= from && t <= to) {
                        const dayKey = new Date(t); dayKey.setHours(0,0,0,0);
                        const bk = buckets.find(b => { const bd = new Date(b.date); bd.setHours(0,0,0,0); return bd.getTime() === dayKey.getTime(); });
                        if (bk) { bk.a.push(r.phaseA); bk.b.push(r.phaseB); bk.c.push(r.phaseC); }
                    }
                });
                const labels = buckets.map(b => b.date.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'}));
                setChartData(labels, buckets.map(b => b.a.length ? avg(b.a) : null), buckets.map(b => b.b.length ? avg(b.b) : null), buckets.map(b => b.c.length ? avg(b.c) : null));
            }
        }
    }

    function avg(arr) { return arr.reduce((s, v) => s + v, 0) / arr.length; }

    function setChartData(labels, dA, dB, dC) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = dA;
        chart.data.datasets[1].data = dB;
        chart.data.datasets[2].data = dC;
        chart.update();
    }

    function changePeriod(key, btn) {
        currentPeriodKey = key;
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const block = document.getElementById('custom-period');
        if (key === 'custom') {
            block.style.display = 'flex';
            const now = new Date();
            const week = new Date(); week.setDate(week.getDate() - 6);
            document.getElementById('date-to').value   = now.toISOString().split('T')[0];
            document.getElementById('date-from').value = week.toISOString().split('T')[0];
        } else {
            block.style.display = 'none';
            updateChart();
        }
    }

    function applyCustomPeriod() {
        updateChart();
    }

    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        const data = [['–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è', '–§–∞–∑–∞ A (–í)', '–§–∞–∑–∞ B (–í)', '–§–∞–∑–∞ C (–í)']];
        voltageHistory.forEach(r => {
            data.push([
                new Date(r.timestamp).toLocaleString('ru-RU'),
                parseFloat(r.phaseA.toFixed(2)),
                parseFloat(r.phaseB.toFixed(2)),
                parseFloat(r.phaseC.toFixed(2))
            ]);
        });
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ');
        XLSX.writeFile(wb, 'voltage_data_' + new Date().toISOString().split('T')[0] + '.xlsx');
    }

    function updateCompliance(v) {
        const phases = [{ name: 'A', val: v.phaseA }, { name: 'B', val: v.phaseB }, { name: 'C', val: v.phaseC }];
        let html = '<ul style="list-style:none;padding:0;">';
        phases.forEach(({ name, val }) => {
            let icon, status;
            if (val >= 207 && val <= 253)         { icon = '‚úÖ'; status = '<span style="color:#155724;font-weight:600;">‚úì –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ—Ä–º–µ</span>'; }
            else if (val >= 195.5 && val <= 264.5) { icon = '‚ö†Ô∏è'; status = '<span style="color:#856404;font-weight:600;">‚ö† –ü—Ä–µ–¥–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</span>'; }
            else                                   { icon = '‚ùå'; status = '<span style="color:#721c24;font-weight:600;">‚úó –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –Ω–æ—Ä–º—ã!</span>'; }
            html += `<li style="padding:8px 0;border-bottom:1px solid #ddd;">${icon} <strong>–§–∞–∑–∞ ${name}:</strong> ${val.toFixed(1)} –í ‚Äî ${status}</li>`;
        });
        html += '</ul>';
        const avg = (v.phaseA + v.phaseB + v.phaseC) / 3;
        html += `<p style="margin-top:15px;font-weight:600;">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ${avg.toFixed(1)} –í</p>`;
        document.getElementById('compliance-info').innerHTML = html;
    }

    function showError(msg) { document.getElementById('error-container').innerHTML = `<div class="error">‚ö†Ô∏è ${msg}</div>`; }
    function clearError()   { document.getElementById('error-container').innerHTML = ''; }

    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        loadData();
        setInterval(loadData, 5 * 60 * 1000);
    });
</script>
</body>
</html>
